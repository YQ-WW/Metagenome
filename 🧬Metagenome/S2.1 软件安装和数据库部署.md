#Project/主线/宏基因组 
[[🧬Metagenome]]
## 1. Conda
[Conda Documentation — conda-docs documentation](https://docs.conda.io/en/latest/#)
- 由本地软件(Anaconda/Miniconda)和远程软件仓库组成
- Anaconda or Miniconda(recommend✅)？
  ![Pasted image 20240918164325.png](./attachments/Pasted%20image%2020240918164325.png)
 - 最流行的Python数据科学管理平台
### 1.1 Bioconda
- conda系统的生物信息软件专用频道
#### 1.1.1可用软件清单
- [Package Index — Bioconda documentation](https://bioconda.github.io/conda-package_index.html)
- 18发表在NM上
  [Bioconda: sustainable and comprehensive software distribution for the life sciences | Nature Methods](https://www.nature.com/articles/s41592-018-0046-7)
#### 1.1.2添加channels
```shell
conda config --add channels bioconda
```
> [Usage — Bioconda documentation](https://bioconda.github.io/)
> [Nature Method：Bioconda解决生物软件安装的烦恼 (qq.com)](https://mp.weixin.qq.com/s/SzJswztVB9rHVh3Ak7jpfA)
#### 1.1.3添加镜像问题
```shell
# 北外镜像加速下载
site=https://mirrors.bfsu.edu.cn/anaconda/  
conda config --add channels ${site}/pkgs/free/  
conda config --add channels ${site}/pkgs/main/  
conda config --add channels ${site}/pkgs/r/  
conda config --add channels ${site}/cloud/conda-forge/conda config --add channels ${site}/cloud/bioconda/

# 如果不可用，请手动在conda配置文件 ~/.condarc 中手动删除  
# （可选)清华/北外维护的Anaconda镜像站加速常用  
```
## 2. 软件安装

### 2.1 常用生物信息软件
[OpenGene - Open Source Genomics Toolbox (github.com)](https://github.com/OpenGene)
- fastp 0.23.2: Fastq序列质控
- MutScan v1.14.1: 突变位置检测和可视化  
- repaq v0.3.0: Fastq序列高压缩比快速解压  
- Fastv 0.8.1: 微生物检测，如SARS-CoV-2  
[shenwei356 (Wei Shen) (github.com)](https://github.com/shenwei356)
通用工具支持Windows / Linux / MacOS的32/64位系统，支持下载或conda安装  
- seqkit 2.4：序列处理  
- csvtk v0.25.0：表格处理  
- taxonkit v0.14.1: NCBI物种信息查询和整理‘
- rush v0.5.0: 任务并行管理软件  

#### 2.1.1 fastp：fastq数据质量评估和质控
[OpenGene/fastp: An ultra-fast all-in-one FASTQ preprocessor (QC/adapters/trimming/filtering/splitting/merging...) (github.com)](https://github.com/OpenGene/fastp)
- 配置
```shell
# 安装（通过bioconda）
conda install fastp -c bioconda
# 具体安装版本和方式，需要看GitHub的官网是否更新
# download the latest build
wget http://opengene.org/fastp/fastp
chmod a+x ./fastp
# 示例：适合单独质控或无需去宿主的环境样本，分析速度极快
```
- Run
```shell
#!/bin/bash

# 创建质控输出目录
mkdir -p temp/qc

# 定义样本列表，适用于多个样本
samples=("C1" "C2" "C3") # 可添加更多样本

# 循环处理每个样本
for i in "${samples[@]}"; do
    echo "Processing sample $i..."

	# 运行 fastp 进行质控，并保存详细的日志信息
	fastp \
	    -i seq/${i}_1.fq.gz \
        -I seq/${i}_2.fq.gz \
        -o temp/qc/${i}_1.fastq \
        -O temp/qc/${i}_2.fastq \
        --html temp/qc/${i}_fastp_report.html \
        --json temp/qc/${i}_fastp_report.json \
        --report_title "Quality Control Report for Sample $i" \
        --thread 4 # 使用多线程提高处理速度
    
    echo "Finished processing sample $i"
done

echo "All samples processed!"
```
#### 2.1.2 seqkit：序列梳理神器-统计、格式转换、长度筛选、质量值转换、翻译、反向互补、抽样、去重、滑窗、拆分等30项全能
[shenwei356/seqkit: A cross-platform and ultrafast toolkit for FASTA/Q file manipulation (github.com)](https://github.com/shenwei356/seqkit)
- 配置
```shell
# 安装 
conda install seqkit -c bioconda  
# 可选在 https://github.com/shenwei356/seqkit/releases 发布页下载  
#  样本批量统计 
seqkit stat seq/*.fq.gz  

```


#### 2.1.3 质控软件fastqc
```shell
# 质量评估软件fastqc  
conda install fastqcfastqc -v # FastQC v0.12.1  

# 多样品评估报告汇总multiqc
conda install multiqc
multiqc --version 
# multiqc, version 1.14  

# 质量控制流程kneaddata，安装最新/指定版解决ID问题
conda install kneaddata  
kneaddata --version # 0.12.0
# 如有问题，可用=指定版本
# conda install kneaddata=0.12.0  

```
## 3. 数据库部署

### 3.1 质控相关数据库安装——人类基因组
```shell
# 查看可用数据库  
kneaddata_database  
# 包括人类基因组human_genome bowtie2、转录组 、小鼠基因组、核糖体SILVA128数据库
# 如下载人类基因组bowtie2索引至指定数据目录
mkdir -p ~/db/kneaddata/human_genome  
kneaddata_database --download human_genome bowtie2  
~/db/kneaddata/human_genome  
# 其它物种可自行下载并使用bowtie2建索引，可参考代码或下方链接教程  
[宏基因组教程Metagenomics Tutorial (HUMAnN2) (qq.com)](https://mp.weixin.qq.com/s/XkfT5MAo96KgyyVaN_Fl7g)
```

### 3.2 自定义基因组构建bowtie2索引-Kneaddata去宿主
大多数基因组可在ensembl genome下载。此处以拟南芥为例，访问  
http://plants.ensembl.org/index.html ，
选择Arabidopsis thaliana ——  Download DNA sequence (FASTA)，
选择toplevel右键复制链接

```shell
# 新建目录、进入并下载链接
mkdir -p ${db}/kneaddata/ath && cd ${db}/kneaddata/ath  

wget -c http://ftp.ensemblgenomes.org/pub/plants/release-  
51/fasta/arabidopsis_thaliana/dna/Arabidopsis_thaliana.TAIR10.dna.toplevel.fa.gz  

gunzip Arabidopsis_thaliana.TAIR10.dna.toplevel.fa.gz
# 简化文件名  
mv Arabidopsis_thaliana.TAIR10.dna.toplevel.fa tair10.fa
# bowtiew建索引，输入文件，输出文件前缀，9线程2分  
time bowtie2-build -f tair10.fa tair10 --threads 9 --seed 1
```

## 4. 设置环境变量
```shell
# 公共数据库database位置，如db公用可能为/db，而自己下载可能为~/db  
db=~/db  
# Conda软件software安装目录，如db公用可能为/conda，而自己下载可能为~/miniconda3  
soft=~/miniconda3  
# wd为项目工作目录work directory，如meta  
wd=~/meta  
```