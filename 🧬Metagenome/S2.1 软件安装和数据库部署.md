#Project/ä¸»çº¿/å®åŸºå› ç»„ 
[[ğŸ§¬Metagenome]]
## 1. Conda
[Conda Documentation â€” conda-docs documentation](https://docs.conda.io/en/latest/#)
- ç”±æœ¬åœ°è½¯ä»¶(Anaconda/Miniconda)å’Œè¿œç¨‹è½¯ä»¶ä»“åº“ç»„æˆ
- Anaconda or Miniconda(recommendâœ…)ï¼Ÿ
  ![Pasted image 20240918164325.png](./attachments/Pasted%20image%2020240918164325.png)
 - æœ€æµè¡Œçš„Pythonæ•°æ®ç§‘å­¦ç®¡ç†å¹³å°
### 1.1 Bioconda
- condaç³»ç»Ÿçš„ç”Ÿç‰©ä¿¡æ¯è½¯ä»¶ä¸“ç”¨é¢‘é“
#### 1.1.1å¯ç”¨è½¯ä»¶æ¸…å•
- [Package Index â€” Bioconda documentation](https://bioconda.github.io/conda-package_index.html)
- 18å‘è¡¨åœ¨NMä¸Š
  [Bioconda: sustainable and comprehensive software distribution for the life sciences | Nature Methods](https://www.nature.com/articles/s41592-018-0046-7)
#### 1.1.2æ·»åŠ channels
```shell
conda config --add channels bioconda
```
> [Usage â€” Bioconda documentation](https://bioconda.github.io/)
> [Nature Methodï¼šBiocondaè§£å†³ç”Ÿç‰©è½¯ä»¶å®‰è£…çš„çƒ¦æ¼ (qq.com)](https://mp.weixin.qq.com/s/SzJswztVB9rHVh3Ak7jpfA)
#### 1.1.3æ·»åŠ é•œåƒé—®é¢˜
```shell
# åŒ—å¤–é•œåƒåŠ é€Ÿä¸‹è½½
site=https://mirrors.bfsu.edu.cn/anaconda/  
conda config --add channels ${site}/pkgs/free/  
conda config --add channels ${site}/pkgs/main/  
conda config --add channels ${site}/pkgs/r/  
conda config --add channels ${site}/cloud/conda-forge/conda config --add channels ${site}/cloud/bioconda/

# å¦‚æœä¸å¯ç”¨ï¼Œè¯·æ‰‹åŠ¨åœ¨condaé…ç½®æ–‡ä»¶ ~/.condarc ä¸­æ‰‹åŠ¨åˆ é™¤  
# ï¼ˆå¯é€‰)æ¸…å/åŒ—å¤–ç»´æŠ¤çš„Anacondaé•œåƒç«™åŠ é€Ÿå¸¸ç”¨  
```
## 2. è½¯ä»¶å®‰è£…

### 2.1 å¸¸ç”¨ç”Ÿç‰©ä¿¡æ¯è½¯ä»¶
[OpenGene - Open Source Genomics Toolbox (github.com)](https://github.com/OpenGene)
- fastp 0.23.2: Fastqåºåˆ—è´¨æ§
- MutScan v1.14.1: çªå˜ä½ç½®æ£€æµ‹å’Œå¯è§†åŒ–  
- repaq v0.3.0: Fastqåºåˆ—é«˜å‹ç¼©æ¯”å¿«é€Ÿè§£å‹  
- Fastv 0.8.1: å¾®ç”Ÿç‰©æ£€æµ‹ï¼Œå¦‚SARS-CoV-2  
[shenwei356 (Wei Shen) (github.com)](https://github.com/shenwei356)
é€šç”¨å·¥å…·æ”¯æŒWindows / Linux / MacOSçš„32/64ä½ç³»ç»Ÿï¼Œæ”¯æŒä¸‹è½½æˆ–condaå®‰è£…  
- seqkit 2.4ï¼šåºåˆ—å¤„ç†  
- csvtk v0.25.0ï¼šè¡¨æ ¼å¤„ç†  
- taxonkit v0.14.1: NCBIç‰©ç§ä¿¡æ¯æŸ¥è¯¢å’Œæ•´ç†â€˜
- rush v0.5.0: ä»»åŠ¡å¹¶è¡Œç®¡ç†è½¯ä»¶  

#### 2.1.1 fastpï¼šfastqæ•°æ®è´¨é‡è¯„ä¼°å’Œè´¨æ§
[OpenGene/fastp: An ultra-fast all-in-one FASTQ preprocessor (QC/adapters/trimming/filtering/splitting/merging...) (github.com)](https://github.com/OpenGene/fastp)
- é…ç½®
```shell
# å®‰è£…ï¼ˆé€šè¿‡biocondaï¼‰
conda install fastp -c bioconda
# å…·ä½“å®‰è£…ç‰ˆæœ¬å’Œæ–¹å¼ï¼Œéœ€è¦çœ‹GitHubçš„å®˜ç½‘æ˜¯å¦æ›´æ–°
# download the latest build
wget http://opengene.org/fastp/fastp
chmod a+x ./fastp
# ç¤ºä¾‹ï¼šé€‚åˆå•ç‹¬è´¨æ§æˆ–æ— éœ€å»å®¿ä¸»çš„ç¯å¢ƒæ ·æœ¬ï¼Œåˆ†æé€Ÿåº¦æå¿«
```
- Run
```shell
#!/bin/bash

# åˆ›å»ºè´¨æ§è¾“å‡ºç›®å½•
mkdir -p temp/qc

# å®šä¹‰æ ·æœ¬åˆ—è¡¨ï¼Œé€‚ç”¨äºå¤šä¸ªæ ·æœ¬
samples=("C1" "C2" "C3") # å¯æ·»åŠ æ›´å¤šæ ·æœ¬

# å¾ªç¯å¤„ç†æ¯ä¸ªæ ·æœ¬
for i in "${samples[@]}"; do
    echo "Processing sample $i..."

	# è¿è¡Œ fastp è¿›è¡Œè´¨æ§ï¼Œå¹¶ä¿å­˜è¯¦ç»†çš„æ—¥å¿—ä¿¡æ¯
	fastp \
	    -i seq/${i}_1.fq.gz \
        -I seq/${i}_2.fq.gz \
        -o temp/qc/${i}_1.fastq \
        -O temp/qc/${i}_2.fastq \
        --html temp/qc/${i}_fastp_report.html \
        --json temp/qc/${i}_fastp_report.json \
        --report_title "Quality Control Report for Sample $i" \
        --thread 4 # ä½¿ç”¨å¤šçº¿ç¨‹æé«˜å¤„ç†é€Ÿåº¦
    
    echo "Finished processing sample $i"
done

echo "All samples processed!"
```
#### 2.1.2 seqkitï¼šåºåˆ—æ¢³ç†ç¥å™¨-ç»Ÿè®¡ã€æ ¼å¼è½¬æ¢ã€é•¿åº¦ç­›é€‰ã€è´¨é‡å€¼è½¬æ¢ã€ç¿»è¯‘ã€åå‘äº’è¡¥ã€æŠ½æ ·ã€å»é‡ã€æ»‘çª—ã€æ‹†åˆ†ç­‰30é¡¹å…¨èƒ½
[shenwei356/seqkit: A cross-platform and ultrafast toolkit for FASTA/Q file manipulation (github.com)](https://github.com/shenwei356/seqkit)
- é…ç½®
```shell
# å®‰è£… 
conda install seqkit -c bioconda  
# å¯é€‰åœ¨ https://github.com/shenwei356/seqkit/releases å‘å¸ƒé¡µä¸‹è½½  
#  æ ·æœ¬æ‰¹é‡ç»Ÿè®¡ 
seqkit stat seq/*.fq.gz  

```


#### 2.1.3 è´¨æ§è½¯ä»¶fastqc
```shell
# è´¨é‡è¯„ä¼°è½¯ä»¶fastqc  
conda install fastqcfastqc -v # FastQC v0.12.1  

# å¤šæ ·å“è¯„ä¼°æŠ¥å‘Šæ±‡æ€»multiqc
conda install multiqc
multiqc --version 
# multiqc, version 1.14  

# è´¨é‡æ§åˆ¶æµç¨‹kneaddataï¼Œå®‰è£…æœ€æ–°/æŒ‡å®šç‰ˆè§£å†³IDé—®é¢˜
conda install kneaddata  
kneaddata --version # 0.12.0
# å¦‚æœ‰é—®é¢˜ï¼Œå¯ç”¨=æŒ‡å®šç‰ˆæœ¬
# conda install kneaddata=0.12.0  

```
## 3. æ•°æ®åº“éƒ¨ç½²

### 3.1 è´¨æ§ç›¸å…³æ•°æ®åº“å®‰è£…â€”â€”äººç±»åŸºå› ç»„
```shell
# æŸ¥çœ‹å¯ç”¨æ•°æ®åº“  
kneaddata_database  
# åŒ…æ‹¬äººç±»åŸºå› ç»„human_genome bowtie2ã€è½¬å½•ç»„ ã€å°é¼ åŸºå› ç»„ã€æ ¸ç³–ä½“SILVA128æ•°æ®åº“
# å¦‚ä¸‹è½½äººç±»åŸºå› ç»„bowtie2ç´¢å¼•è‡³æŒ‡å®šæ•°æ®ç›®å½•
mkdir -p ~/db/kneaddata/human_genome  
kneaddata_database --download human_genome bowtie2  
~/db/kneaddata/human_genome  
# å…¶å®ƒç‰©ç§å¯è‡ªè¡Œä¸‹è½½å¹¶ä½¿ç”¨bowtie2å»ºç´¢å¼•ï¼Œå¯å‚è€ƒä»£ç æˆ–ä¸‹æ–¹é“¾æ¥æ•™ç¨‹  
[å®åŸºå› ç»„æ•™ç¨‹Metagenomics Tutorial (HUMAnN2) (qq.com)](https://mp.weixin.qq.com/s/XkfT5MAo96KgyyVaN_Fl7g)
```

### 3.2 è‡ªå®šä¹‰åŸºå› ç»„æ„å»ºbowtie2ç´¢å¼•-Kneaddataå»å®¿ä¸»
å¤§å¤šæ•°åŸºå› ç»„å¯åœ¨ensembl genomeä¸‹è½½ã€‚æ­¤å¤„ä»¥æ‹Ÿå—èŠ¥ä¸ºä¾‹ï¼Œè®¿é—®  
http://plants.ensembl.org/index.html ï¼Œ
é€‰æ‹©Arabidopsis thaliana â€”â€”  Download DNA sequence (FASTA)ï¼Œ
é€‰æ‹©toplevelå³é”®å¤åˆ¶é“¾æ¥

```shell
# æ–°å»ºç›®å½•ã€è¿›å…¥å¹¶ä¸‹è½½é“¾æ¥
mkdir -p ${db}/kneaddata/ath && cd ${db}/kneaddata/ath  

wget -c http://ftp.ensemblgenomes.org/pub/plants/release-  
51/fasta/arabidopsis_thaliana/dna/Arabidopsis_thaliana.TAIR10.dna.toplevel.fa.gz  

gunzip Arabidopsis_thaliana.TAIR10.dna.toplevel.fa.gz
# ç®€åŒ–æ–‡ä»¶å  
mv Arabidopsis_thaliana.TAIR10.dna.toplevel.fa tair10.fa
# bowtiewå»ºç´¢å¼•ï¼Œè¾“å…¥æ–‡ä»¶ï¼Œè¾“å‡ºæ–‡ä»¶å‰ç¼€ï¼Œ9çº¿ç¨‹2åˆ†  
time bowtie2-build -f tair10.fa tair10 --threads 9 --seed 1
```

## 4. è®¾ç½®ç¯å¢ƒå˜é‡
```shell
# å…¬å…±æ•°æ®åº“databaseä½ç½®ï¼Œå¦‚dbå…¬ç”¨å¯èƒ½ä¸º/dbï¼Œè€Œè‡ªå·±ä¸‹è½½å¯èƒ½ä¸º~/db  
db=~/db  
# Condaè½¯ä»¶softwareå®‰è£…ç›®å½•ï¼Œå¦‚dbå…¬ç”¨å¯èƒ½ä¸º/condaï¼Œè€Œè‡ªå·±ä¸‹è½½å¯èƒ½ä¸º~/miniconda3  
soft=~/miniconda3  
# wdä¸ºé¡¹ç›®å·¥ä½œç›®å½•work directoryï¼Œå¦‚meta  
wd=~/meta  
```